name: Daily Playwright Test

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  test:
    runs-on: [self-hosted]
    env:
      PYTHON_PATH: C:\Users\NHN\AppData\Local\Programs\Python\Python311
      PYTHONIOENCODING: utf-8
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install dependencies
        shell: cmd
        run: |
          "${{ env.PYTHON_PATH }}\python.exe" -m pip install --user -r requirements.txt
          "${{ env.PYTHON_PATH }}\python.exe" -m pip install --user pytest-html
          "${{ env.PYTHON_PATH }}\python.exe" -m playwright install
      
      - name: Create .env file
        shell: cmd
        run: |
          (
            echo fr_username=${{ secrets.FR_USERNAME }}
            echo fr_password=${{ secrets.FR_PASSWORD }}
            echo va_username=${{ secrets.VA_USERNAME }}
            echo va_password=${{ secrets.VA_PASSWORD }}
            echo wa1_username=${{ secrets.WA1_USERNAME }}
            echo wa1_password=${{ secrets.WA1_PASSWORD }}
            echo wa2_username=${{ secrets.WA2_USERNAME }}
            echo wa2_password=${{ secrets.WA2_PASSWORD }}
            echo mo_username=${{ secrets.MO_USERNAME }}
            echo mo_password=${{ secrets.MO_PASSWORD }}
            echo fr_user_id=${{ secrets.FR_USER_ID }}
            echo fr_user_mobile_id=${{ secrets.FR_USER_MOBILE_ID }}
          ) > .env
      
      - name: Run Precondition tests
        shell: cmd
        run: |
          chcp 65001
          "${{ env.PYTHON_PATH }}\python.exe" -m pytest tests/precondition -v -s --tb=short --junitxml=output/precondition-results.xml --html=output/precondition-report.html --self-contained-html
        continue-on-error: true

      - name: Run Front tests
        shell: cmd
        run: |
          chcp 65001
          "${{ env.PYTHON_PATH }}\python.exe" -m pytest tests/front -v -s --tb=short --junitxml=output/front-results.xml --html=output/front-report.html --self-contained-html
        continue-on-error: true

      - name: Run Mobile tests
        shell: cmd
        run: |
          chcp 65001
          "${{ env.PYTHON_PATH }}\python.exe" -m pytest tests/mobile -v -s --tb=short --junitxml=output/mobile-results.xml --html=output/mobile-report.html --self-contained-html
        continue-on-error: true

      - name: Run Vendor Admin tests
        shell: cmd
        run: |
          chcp 65001
          "${{ env.PYTHON_PATH }}\python.exe" -m pytest tests/va -v -s --tb=short --junitxml=output/va-results.xml --html=output/va-report.html --self-contained-html
        continue-on-error: true

      - name: Run Web Admin tests
        shell: cmd
        run: |
          chcp 65001
          "${{ env.PYTHON_PATH }}\python.exe" -m pytest tests/wa -v -s --tb=short --junitxml=output/wa-results.xml --html=output/wa-report.html --self-contained-html
        continue-on-error: true
      
      - name: Generate test summary
        if: always()
        shell: cmd
        run: |
          powershell -Command {
            $summary = @"
            ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            FG Automation Test Results
            ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            "@
            
            $totalPassed = 0
            $totalFailed = 0
            $totalErrors = 0
            $totalSkipped = 0
            $totalTests = 0
            
            $xmlFiles = @("precondition-results.xml", "front-results.xml", "mobile-results.xml", "va-results.xml", "wa-results.xml")
            
            foreach ($xmlFile in $xmlFiles) {
              $path = "output/$xmlFile"
              if (Test-Path $path) {
                [xml]$xml = Get-Content $path
                $testsuite = $xml.testsuites.testsuite
                
                if ($testsuite -ne $null) {
                  $total = [int]$testsuite.tests
                  $passed = $total - [int]$testsuite.failures - [int]$testsuite.errors - [int]$testsuite.skipped
                  $failed = [int]$testsuite.failures
                  $errors = [int]$testsuite.errors
                  $skipped = [int]$testsuite.skipped
                  
                  $totalPassed += $passed
                  $totalFailed += $failed
                  $totalErrors += $errors
                  $totalSkipped += $skipped
                  $totalTests += $total
                  
                  $testType = $xmlFile -replace "-results.xml"
                  $status = if ($failed -eq 0 -and $errors -eq 0) { "✅" } else { "❌" }
                  
                  $summary += @"
            $status $testType.ToUpper()
               Passed:  $passed
               Failed:  $failed
               Errors:  $errors
               Skipped: $skipped
               
            "@
                }
              }
            }
            
            $summary += @"
            ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            Total Summary
            ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            ✅ Total Passed:  $totalPassed
            ❌ Total Failed:  $totalFailed
            ⚠️ Total Errors:  $totalErrors
             ⏭ Total Skipped: $totalSkipped
            ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
               Grand Total:  $totalTests tests
            
            HTML Reports:
            - precondition-report.html
            - front-report.html
            - mobile-report.html
            - va-report.html
            - wa-report.html
            
            "@
            
            $summary | Out-File -FilePath output/summary.txt -Encoding UTF8
            Add-Content -Path $env:GITHUB_OUTPUT -Value "summary<<EOF"
            Add-Content -Path $env:GITHUB_OUTPUT -Value $summary
            Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"
          }
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: output/
          retention-days: 7

      - name: Send email with results
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.dooray.com
          server_port: 465
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}
          subject: FG Automation Playwright Test Results
          to: taehyung-moon@nhnservice.com, seungbin.an@nhnservice.com
          from: ${{ secrets.MAIL_USER }}
          body: |
            FG Automation Playwright 테스트가 완료되었습니다.

            ${{ steps.summary.outputs.summary }}

            상세 결과는 Artifacts에서 HTML 리포트를 다운로드하여 확인하세요.
            GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}